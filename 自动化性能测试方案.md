# UIç»„ä»¶è‡ªåŠ¨åŒ–æ€§èƒ½æµ‹è¯•æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•
1. [æµ‹è¯•æ¡†æ¶æ­å»º](#æµ‹è¯•æ¡†æ¶æ­å»º)
2. [æ€§èƒ½æŒ‡æ ‡å®šä¹‰](#æ€§èƒ½æŒ‡æ ‡å®šä¹‰)
3. [æµ‹è¯•ç”¨ä¾‹è®¾è®¡](#æµ‹è¯•ç”¨ä¾‹è®¾è®¡)
4. [æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ](#æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ)
5. [æŒç»­é›†æˆ](#æŒç»­é›†æˆ)

---

## æµ‹è¯•æ¡†æ¶æ­å»º

### 1. ä¾èµ–é…ç½®

åœ¨`app/build.gradle`ä¸­æ·»åŠ æµ‹è¯•ä¾èµ–ï¼š

```gradle
dependencies {
    // AndroidX Test
    androidTestImplementation 'androidx.test.ext:junit:1.1.5'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
    
    // æ€§èƒ½æµ‹è¯•å·¥å…·
    androidTestImplementation 'androidx.benchmark:benchmark-junit4:1.2.0'
    
    // UIè‡ªåŠ¨åŒ–
    androidTestImplementation 'androidx.test.uiautomator:uiautomator:2.2.0'
}
```

### 2. æ€§èƒ½ç›‘æ§å·¥å…·ç±»

åˆ›å»º`PerformanceMonitor.java`ï¼š

```java
package com.example.androiduidemo.test;

import android.app.ActivityManager;
import android.content.Context;
import android.os.Debug;
import android.os.SystemClock;
import android.util.Log;

import java.util.ArrayList;
import java.util.List;

/**
 * æ€§èƒ½ç›‘æ§å·¥å…·ç±»
 */
public class PerformanceMonitor {
    private static final String TAG = "PerformanceMonitor";
    
    private Context context;
    private ActivityManager activityManager;
    private List<Long> frameTimes = new ArrayList<>();
    private long startTime;
    private long lastFrameTime;
    
    public PerformanceMonitor(Context context) {
        this.context = context;
        this.activityManager = (ActivityManager) context.getSystemService(Context.ACTIVITY_SERVICE);
    }
    
    /**
     * è·å–å½“å‰å†…å­˜ä½¿ç”¨ï¼ˆMBï¼‰
     */
    public long getUsedMemory() {
        ActivityManager.MemoryInfo memoryInfo = new ActivityManager.MemoryInfo();
        activityManager.getMemoryInfo(memoryInfo);
        return (memoryInfo.totalMem - memoryInfo.availMem) / (1024 * 1024);
    }
    
    /**
     * è·å–PSSå†…å­˜ï¼ˆMBï¼‰
     */
    public long getPssMemory() {
        Debug.MemoryInfo memoryInfo = new Debug.MemoryInfo();
        Debug.getMemoryInfo(memoryInfo);
        return memoryInfo.getTotalPss() / 1024;
    }
    
    /**
     * å¼€å§‹å¸§ç‡ç›‘æ§
     */
    public void startFrameRateMonitoring() {
        frameTimes.clear();
        startTime = SystemClock.elapsedRealtime();
        lastFrameTime = SystemClock.elapsedRealtimeNanos();
    }
    
    /**
     * è®°å½•ä¸€å¸§
     */
    public void recordFrame() {
        long currentTime = SystemClock.elapsedRealtimeNanos();
        long frameInterval = currentTime - lastFrameTime;
        frameTimes.add(frameInterval);
        lastFrameTime = currentTime;
    }
    
    /**
     * è·å–å¹³å‡å¸§ç‡
     */
    public float getAverageFps() {
        if (frameTimes.isEmpty()) {
            return 0;
        }
        long totalTime = 0;
        for (Long time : frameTimes) {
            totalTime += time;
        }
        long avgFrameTime = totalTime / frameTimes.size();
        return 1_000_000_000f / avgFrameTime;
    }
    
    /**
     * è·å–æœ€ä½å¸§ç‡
     */
    public float getMinFps() {
        if (frameTimes.isEmpty()) {
            return 0;
        }
        long maxFrameTime = 0;
        for (Long time : frameTimes) {
            if (time > maxFrameTime) {
                maxFrameTime = time;
            }
        }
        return 1_000_000_000f / maxFrameTime;
    }
    
    /**
     * è·å–CPUä½¿ç”¨ç‡ï¼ˆéœ€è¦rootæƒé™æˆ–ç³»ç»Ÿæƒé™ï¼‰
     */
    public float getCpuUsage() {
        // ç®€åŒ–å®ç°ï¼Œå®é™…éœ€è¦è¯»å–/proc/stat
        return 0f;
    }
}
```

---

## æ€§èƒ½æŒ‡æ ‡å®šä¹‰

### æ ¸å¿ƒæ€§èƒ½æŒ‡æ ‡

#### 1. å†…å­˜æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|----------|
| **åˆå§‹å†…å­˜å ç”¨** | < 1MB | ç»„ä»¶åˆ›å»ºåç«‹å³æµ‹é‡ |
| **å³°å€¼å†…å­˜å ç”¨** | < 5MB | è¿è¡Œè¿‡ç¨‹ä¸­æœ€å¤§å†…å­˜ |
| **å†…å­˜å¢é•¿** | < 2MB | é•¿æ—¶é—´è¿è¡Œåå†…å­˜å¢é•¿ |
| **å†…å­˜æ³„æ¼** | 0 | åˆ›å»ºé”€æ¯100æ¬¡åå†…å­˜ä¸å¢é•¿ |

#### 2. å¸§ç‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|----------|
| **å¹³å‡å¸§ç‡** | â‰¥ 55fps | åŠ¨ç”»æœŸé—´å¹³å‡å¸§ç‡ |
| **æœ€ä½å¸§ç‡** | â‰¥ 50fps | åŠ¨ç”»æœŸé—´æœ€ä½å¸§ç‡ |
| **å¸§ç‡ç¨³å®šæ€§** | â‰¥ 90% | å¸§ç‡æ³¢åŠ¨èŒƒå›´ |
| **æ‰å¸§æ¬¡æ•°** | < 5æ¬¡/ç§’ | å¸§æ—¶é—´>16.67msçš„æ¬¡æ•° |

#### 3. åˆ›å»ºæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|----------|
| **åˆ›å»ºæ—¶é—´** | < 10ms | ç»„ä»¶åˆ›å»ºè€—æ—¶ |
| **åˆå§‹åŒ–æ—¶é—´** | < 20ms | å®Œæ•´åˆå§‹åŒ–è€—æ—¶ |
| **å¸ƒå±€æ—¶é—´** | < 5ms | å¸ƒå±€æµ‹é‡å’Œå¸ƒå±€è€—æ—¶ |

#### 4. åŠ¨ç”»æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹è¯•æ–¹æ³• |
|------|--------|----------|
| **åŠ¨ç”»æµç•…åº¦** | æ— å¡é¡¿ | åŠ¨ç”»æœŸé—´å¸§ç‡ç¨³å®š |
| **CPUå ç”¨** | < 5% | åŠ¨ç”»æœŸé—´CPUä½¿ç”¨ç‡ |
| **åŠ¨ç”»å®Œæˆæ—¶é—´** | è¯¯å·®<50ms | å®é™…å®Œæˆæ—¶é—´vsè®¾å®šæ—¶é—´ |

---

## æµ‹è¯•ç”¨ä¾‹è®¾è®¡

### æµ‹è¯•ç±»ç»“æ„

```java
@RunWith(AndroidJUnit4.class)
@LargeTest
public class LoadingPerformanceTest {
    
    private ActivityTestRule<LoadingTestActivity> activityRule =
            new ActivityTestRule<>(LoadingTestActivity.class);
    
    private PerformanceMonitor monitor;
    
    @Before
    public void setUp() {
        monitor = new PerformanceMonitor(activityRule.getActivity());
    }
    
    // æµ‹è¯•ç”¨ä¾‹...
}
```

### æµ‹è¯•ç”¨ä¾‹1ï¼šå†…å­˜å ç”¨æµ‹è¯•

```java
@Test
public void testMemoryUsage() {
    Activity activity = activityRule.getActivity();
    
    // 1. è®°å½•åˆå§‹å†…å­˜
    long initialMemory = monitor.getUsedMemory();
    Log.d("Performance", "åˆå§‹å†…å­˜: " + initialMemory + " MB");
    
    // 2. åˆ›å»ºç»„ä»¶
    Loading.show(activity);
    
    // 3. ç­‰å¾…ç¨³å®š
    SystemClock.sleep(500);
    
    // 4. è®°å½•åˆ›å»ºåå†…å­˜
    long afterCreateMemory = monitor.getUsedMemory();
    long memoryUsed = afterCreateMemory - initialMemory;
    Log.d("Performance", "åˆ›å»ºåå†…å­˜: " + afterCreateMemory + " MB");
    Log.d("Performance", "å†…å­˜å ç”¨: " + memoryUsed + " MB");
    
    // 5. æ–­è¨€ï¼šå†…å­˜å ç”¨åº”è¯¥å°äº1MB
    assertTrue("å†…å­˜å ç”¨è¿‡å¤§: " + memoryUsed + " MB", memoryUsed < 1);
    
    // 6. æ¸…ç†
    Loading.hide();
}
```

### æµ‹è¯•ç”¨ä¾‹2ï¼šå†…å­˜æ³„æ¼æµ‹è¯•

```java
@Test
public void testMemoryLeak() {
    Activity activity = activityRule.getActivity();
    
    // 1. è®°å½•åˆå§‹å†…å­˜
    long initialMemory = monitor.getPssMemory();
    Log.d("Performance", "åˆå§‹PSSå†…å­˜: " + initialMemory + " MB");
    
    // 2. åˆ›å»ºå’Œé”€æ¯ç»„ä»¶100æ¬¡
    for (int i = 0; i < 100; i++) {
        Loading.show(activity);
        SystemClock.sleep(10);
        Loading.hide();
        SystemClock.sleep(10);
    }
    
    // 3. å¼ºåˆ¶GC
    System.gc();
    SystemClock.sleep(500);
    
    // 4. å†æ¬¡å¼ºåˆ¶GC
    System.gc();
    SystemClock.sleep(500);
    
    // 5. è®°å½•æœ€ç»ˆå†…å­˜
    long finalMemory = monitor.getPssMemory();
    long memoryGrowth = finalMemory - initialMemory;
    Log.d("Performance", "æœ€ç»ˆPSSå†…å­˜: " + finalMemory + " MB");
    Log.d("Performance", "å†…å­˜å¢é•¿: " + memoryGrowth + " MB");
    
    // 6. æ–­è¨€ï¼šå†…å­˜å¢é•¿åº”è¯¥å°äº2MB
    assertTrue("å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œå†…å­˜å¢é•¿: " + memoryGrowth + " MB", 
               memoryGrowth < 2);
}
```

### æµ‹è¯•ç”¨ä¾‹3ï¼šå¸§ç‡æµ‹è¯•

```java
@Test
public void testFrameRate() {
    Activity activity = activityRule.getActivity();
    CustomProgressBar progressBar = activity.findViewById(R.id.progress_bar);
    
    // 1. å¯åŠ¨å¸§ç‡ç›‘æ§
    monitor.startFrameRateMonitoring();
    
    // 2. æ‰§è¡ŒåŠ¨ç”»
    progressBar.setProgress(0f, false);
    progressBar.setProgress(1f, true);  // åŠ¨ç”»åˆ°100%
    
    // 3. åœ¨åŠ¨ç”»æœŸé—´è®°å½•å¸§
    long startTime = SystemClock.elapsedRealtime();
    while (SystemClock.elapsedRealtime() - startTime < 1000) {
        // æ¨¡æ‹Ÿæ¯å¸§è®°å½•ï¼ˆå®é™…åº”è¯¥ç”¨Choreographerï¼‰
        monitor.recordFrame();
        SystemClock.sleep(16);  // æ¨¡æ‹Ÿ60fps
    }
    
    // 4. è·å–å¸§ç‡
    float avgFps = monitor.getAverageFps();
    float minFps = monitor.getMinFps();
    
    Log.d("Performance", "å¹³å‡å¸§ç‡: " + avgFps + " fps");
    Log.d("Performance", "æœ€ä½å¸§ç‡: " + minFps + " fps");
    
    // 5. æ–­è¨€ï¼šå¹³å‡å¸§ç‡åº”è¯¥>=55fps
    assertTrue("å¸§ç‡è¿‡ä½: " + avgFps + " fps", avgFps >= 55f);
    assertTrue("æœ€ä½å¸§ç‡è¿‡ä½: " + minFps + " fps", minFps >= 50f);
}
```

### æµ‹è¯•ç”¨ä¾‹4ï¼šåˆ›å»ºæ€§èƒ½æµ‹è¯•

```java
@Test
public void testCreationPerformance() {
    Activity activity = activityRule.getActivity();
    
    // 1. é¢„çƒ­ï¼ˆé¿å…é¦–æ¬¡åˆ›å»ºæ…¢ï¼‰
    Loading.show(activity);
    Loading.hide();
    SystemClock.sleep(100);
    
    // 2. æµ‹è¯•åˆ›å»ºæ—¶é—´
    long totalTime = 0;
    int iterations = 100;
    
    for (int i = 0; i < iterations; i++) {
        long startTime = SystemClock.elapsedRealtimeNanos();
        Loading.show(activity);
        long createTime = SystemClock.elapsedRealtimeNanos() - startTime;
        totalTime += createTime;
        Loading.hide();
    }
    
    long avgTime = totalTime / iterations / 1_000_000;  // è½¬æ¢ä¸ºæ¯«ç§’
    Log.d("Performance", "å¹³å‡åˆ›å»ºæ—¶é—´: " + avgTime + " ms");
    
    // 3. æ–­è¨€ï¼šå¹³å‡åˆ›å»ºæ—¶é—´åº”è¯¥<10ms
    assertTrue("åˆ›å»ºæ—¶é—´è¿‡é•¿: " + avgTime + " ms", avgTime < 10);
}
```

### æµ‹è¯•ç”¨ä¾‹5ï¼šå‹åŠ›æµ‹è¯•

```java
@Test
public void testStressTest() {
    Activity activity = activityRule.getActivity();
    
    // 1. è®°å½•åˆå§‹å†…å­˜
    long initialMemory = monitor.getUsedMemory();
    
    // 2. å¿«é€Ÿåˆ›å»ºå¤§é‡ç»„ä»¶
    List<LoadingManager> managers = new ArrayList<>();
    for (int i = 0; i < 50; i++) {
        LoadingManager manager = LoadingManager.with(activity);
        manager.show("æµ‹è¯• " + i);
        managers.add(manager);
    }
    
    // 3. ç­‰å¾…ç¨³å®š
    SystemClock.sleep(1000);
    
    // 4. è®°å½•å³°å€¼å†…å­˜
    long peakMemory = monitor.getUsedMemory();
    long memoryUsed = peakMemory - initialMemory;
    
    Log.d("Performance", "å‹åŠ›æµ‹è¯• - åˆå§‹å†…å­˜: " + initialMemory + " MB");
    Log.d("Performance", "å‹åŠ›æµ‹è¯• - å³°å€¼å†…å­˜: " + peakMemory + " MB");
    Log.d("Performance", "å‹åŠ›æµ‹è¯• - å†…å­˜å ç”¨: " + memoryUsed + " MB");
    
    // 5. æ¸…ç†
    for (LoadingManager manager : managers) {
        manager.hide();
    }
    
    // 6. æ–­è¨€ï¼š50ä¸ªç»„ä»¶å†…å­˜å ç”¨åº”è¯¥<10MB
    assertTrue("å‹åŠ›æµ‹è¯•å¤±è´¥ï¼Œå†…å­˜å ç”¨: " + memoryUsed + " MB", memoryUsed < 10);
}
```

---

## æµ‹è¯•æŠ¥å‘Šç”Ÿæˆ

### æŠ¥å‘Šæ ¼å¼

```java
public class PerformanceReport {
    private String componentName;
    private List<TestResult> results = new ArrayList<>();
    
    public void addResult(String testName, boolean passed, String message, Map<String, Object> metrics) {
        results.add(new TestResult(testName, passed, message, metrics));
    }
    
    public String generateReport() {
        StringBuilder sb = new StringBuilder();
        sb.append("# ").append(componentName).append(" æ€§èƒ½æµ‹è¯•æŠ¥å‘Š\n\n");
        sb.append("## æµ‹è¯•æ—¶é—´: ").append(new Date()).append("\n\n");
        
        int passed = 0, failed = 0;
        for (TestResult result : results) {
            if (result.passed) passed++;
            else failed++;
        }
        
        sb.append("## æµ‹è¯•æ¦‚è§ˆ\n");
        sb.append("- æ€»æµ‹è¯•æ•°: ").append(results.size()).append("\n");
        sb.append("- é€šè¿‡: ").append(passed).append("\n");
        sb.append("- å¤±è´¥: ").append(failed).append("\n\n");
        
        sb.append("## è¯¦ç»†ç»“æœ\n\n");
        for (TestResult result : results) {
            sb.append("### ").append(result.testName).append("\n");
            sb.append("- çŠ¶æ€: ").append(result.passed ? "âœ… é€šè¿‡" : "âŒ å¤±è´¥").append("\n");
            sb.append("- è¯´æ˜: ").append(result.message).append("\n");
            if (result.metrics != null) {
                sb.append("- æŒ‡æ ‡:\n");
                for (Map.Entry<String, Object> entry : result.metrics.entrySet()) {
                    sb.append("  - ").append(entry.getKey()).append(": ").append(entry.getValue()).append("\n");
                }
            }
            sb.append("\n");
        }
        
        return sb.toString();
    }
}
```

---

## æŒç»­é›†æˆ

### GitHub Actionsé…ç½®

åˆ›å»º`.github/workflows/performance-test.yml`ï¼š

```yaml
name: Performance Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  performance-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        
    - name: Run performance tests
      run: |
        ./gradlew connectedAndroidTest
        
    - name: Generate report
      run: |
        # ç”Ÿæˆæ€§èƒ½æµ‹è¯•æŠ¥å‘Š
        ./gradlew generatePerformanceReport
        
    - name: Upload report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: build/reports/performance/
```

---

## æ€§èƒ½æµ‹è¯•æœ€ä½³å®è·µ

### 1. æµ‹è¯•ç¯å¢ƒ
- âœ… ä½¿ç”¨çœŸå®è®¾å¤‡æµ‹è¯•ï¼ˆä¸è¦ç”¨æ¨¡æ‹Ÿå™¨ï¼‰
- âœ… å…³é—­å…¶ä»–åº”ç”¨ï¼Œç¡®ä¿æµ‹è¯•ç¯å¢ƒå¹²å‡€
- âœ… è®¾å¤‡ç”µé‡å……è¶³ï¼Œé¿å…é™é¢‘
- âœ… æµ‹è¯•å‰é‡å¯è®¾å¤‡ï¼Œç¡®ä¿å¹²å‡€çŠ¶æ€

### 2. æµ‹è¯•æ–¹æ³•
- âœ… å¤šæ¬¡æµ‹è¯•å–å¹³å‡å€¼
- âœ… é¢„çƒ­åå†æµ‹è¯•ï¼ˆé¿å…é¦–æ¬¡åˆ›å»ºæ…¢ï¼‰
- âœ… æµ‹è¯•ä¸åŒåœºæ™¯ï¼ˆæ­£å¸¸ã€å‹åŠ›ã€è¾¹ç•Œï¼‰
- âœ… è®°å½•è¯¦ç»†æ—¥å¿—

### 3. ç»“æœåˆ†æ
- âœ… å¯¹æ¯”ä¸åŒç‰ˆæœ¬çš„æ€§èƒ½
- âœ… åˆ†ææ€§èƒ½ç“¶é¢ˆ
- âœ… è®°å½•ä¼˜åŒ–æ•ˆæœ
- âœ… å»ºç«‹æ€§èƒ½åŸºçº¿

---

**é€šè¿‡è¿™å¥—è‡ªåŠ¨åŒ–æµ‹è¯•æ–¹æ¡ˆï¼Œå¯ä»¥æŒç»­ç›‘æ§UIç»„ä»¶çš„æ€§èƒ½ï¼Œç¡®ä¿ç»„ä»¶è´¨é‡ï¼** ğŸš€

